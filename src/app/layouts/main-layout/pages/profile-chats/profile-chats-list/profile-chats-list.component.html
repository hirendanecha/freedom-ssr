<div class="chat-area position-relative">
  <ng-container
    *ngIf="
      (!userChat?.roomId && userChat?.isAccepted === 'N') ||
      (userChat?.Id && !userChat?.roomId)
    "
  >
    <div class="d-flex flex-column align-items-center mt-5">
      <div
        class="d-flex flex-column justify-content-center align-items-center gap-3 my-8 p-6 rounded-3 box-bg w-75"
      >
        <img
          [src]="userChat.ProfilePicName"
          class="w-60-px h-60-px"
          alt="image"
          onerror="this.onerror=null;this.src='/assets/images/avtar/placeholder-user.png';"
        />
        <h5>send invite to {{ userChat?.Username }} for chat</h5>
        <div>
          <button class="btn btn-danger mx-3" (click)="onCancel()">
            Cancel
          </button>
          <button class="btn btn-primary mx-3" (click)="createChatRoom()">
            Invite
          </button>
        </div>
      </div>
    </div>
  </ng-container>
  <!-- ui fourth -->
  <ng-container *ngIf="!userChat?.Username && !userChat?.groupId">
    <div class="d-flex flex-column align-items-center mt-5">
      <div
        class="d-flex flex-row justify-content-center align-items-center gap-5 my-8 p-6 w-75 rounded-3 box-bg"
      >
        <img
          [src]="sharedService?.userData?.ProfilePicName"
          class="rounded-circle w-60-px h-60-px"
          alt="image"
          onerror="this.onerror=null;this.src='/assets/images/avtar/placeholder-user.png';"
        />
        <div>
          <h5>welcome</h5>
          <h5>{{ sharedService?.userData?.Username }}</h5>
        </div>
      </div>
    </div>
    <!-- <div class="d-flex flex-column">
      <div class="d-center flex-column p-3">
        <span class="mb-2">Scan the QR code with your device</span>
        <qrcode
          [qrdata]="qrLink"
          [width]="200"
          [errorCorrectionLevel]="'Q'"
        >
      </qrcode>
      </div>
    </div> -->
  </ng-container>
  <ng-container *ngIf="userChat.roomId || userChat.groupId">
    <div class="main">
      <div
        class="chat-head py-2 px-3 position-relative"
        *ngIf="userChat?.createdBy"
      >
        <div class="d-center justify-content-between h-58-px">
          <div
            class="d-flex gap-4 align-items-center c-pointer"
            (click)="userChat.groupId ? groupEditDetails(groupData) : ''"
          >
            <img
              [src]="userChat?.profileImage || userChat?.ProfilePicName"
              class="rounded-circle header-image"
              alt="image"
              onerror="this.onerror=null;this.src='/assets/images/avtar/placeholder-user.png';"
            />
            <div class="d-flex align-items-baseline">
              <div class="profile-status">
                <h5 class="m-0">
                  <a class="m-0">{{
                    groupData?.groupName ||
                      userChat?.groupName ||
                      userChat?.Username
                  }}</a>
                </h5>
                <ng-container *ngIf="userChat.roomId">
                  <span class="mdtxt">{{ isOnline ? "online" : "" }}</span>
                </ng-container>
                <ng-container *ngIf="userChat.groupId">
                  <span>{{ groupData?.members }} participants</span>
                </ng-container>
              </div>
              <fa-icon
                [icon]="['fas', 'gear']"
                class="font-20-px m-1 ms-3 d-none d-sm-flex"
                *ngIf="userChat.groupId"
              />
            </div>
          </div>
          <div
            class="d-flex gap-3 align-items-center"
            *ngIf="userChat.isAccepted === 'Y'"
          >
            <a class="d-none d-sm-flex" (click)="openSearch(isSearch)">
              <fa-icon
                [icon]="['fas', 'search']"
                class="font-20-px m-1 ms-3 d-flex c-pointer"
              />
            </a>
            <a
              class="nav-icon cursor d-sm-none d-flex align-items-center gap-2"
              data-toggle="tooltip"
              data-placement="bottom"
              title="Video Call"
              (click)="startCall()"
              ><fa-icon [icon]="['fas', 'phone']" class="font-20-px m-1" />
            </a>

            <div
              ngbDropdown
              class="avatar-item online-status"
              [ngClass]="!sidebarClass ? 'd-none d-md-block' : 'd-none'"
            >
              <!--  -->
              <button
                ngbDropdownToggle
                class="abs-activity d-center smtxt"
                [ngClass]="{
                  'abs-active ': sharedService.userData.userStatus === 'active',
                  'abs-away': sharedService.userData.userStatus === 'away',
                  'abs-dnd': sharedService.userData.userStatus === 'dnd',
                  'abs-invisible':
                    sharedService.userData.userStatus === 'invisible'
                }"
              ></button>
              <div ngbDropdownMenu class="dropdown-menu">
                <div class="dropdown-preferences">
                  <div class="d-flex flex-column pe-2">
                    <div
                      class="c-pointer d-flex justify-content-between align-items-baseline"
                    >
                      <h6
                        ngbDropdownItem
                        class="d-flex w-100"
                        (click)="profileStatus('active')"
                      >
                        Active
                      </h6>
                      <fa-icon
                        [icon]="['fas', 'check']"
                        class="font-20-px"
                        *ngIf="sharedService.userData.userStatus === 'active'"
                      />
                    </div>
                    <div
                      class="c-pointer d-flex align-items-baseline justify-content-between"
                    >
                      <h6
                        ngbDropdownItem
                        class="d-flex w-100"
                        (click)="profileStatus('away')"
                      >
                        Away
                      </h6>
                      <fa-icon
                        [icon]="['fas', 'check']"
                        class="font-20-px"
                        *ngIf="sharedService.userData.userStatus === 'away'"
                      />
                    </div>
                    <div
                      class="c-pointer d-flex align-items-baseline justify-content-between"
                    >
                      <h6
                        ngbDropdownItem
                        class="d-flex w-100"
                        (click)="profileStatus('dnd')"
                      >
                        Do not disturb
                      </h6>
                      <fa-icon
                        [icon]="['fas', 'check']"
                        class="font-20-px"
                        *ngIf="sharedService.userData.userStatus === 'dnd'"
                      />
                    </div>
                    <div
                      class="c-pointer d-flex align-items-baseline justify-content-between"
                    >
                      <h6
                        ngbDropdownItem
                        class="d-flex w-100"
                        (click)="profileStatus('invisible')"
                      >
                        Invisible
                      </h6>
                      <fa-icon
                        [icon]="['fas', 'check']"
                        class="font-20-px"
                        *ngIf="
                          sharedService.userData.userStatus === 'invisible'
                        "
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <a (click)="groupEditDetails(groupData)">
              <fa-icon
                [icon]="['fas', 'gear']"
                class="font-20-px m-1 ms-3 d-sm-none d-flex"
                *ngIf="userChat.groupId"
              />
            </a>

            <div class="gap-3 d-none d-sm-flex flex-wrap">
              <a
                [ngClass]="sidebarClass ? 'd-none' : ''"
                *ngIf="userChat.roomId || userChat.groupId"
                class="nav-icon cursor"
                data-toggle="tooltip"
                data-placement="bottom"
                title="Media Gallery"
                (click)="openMediaGallery()"
                ><fa-icon [icon]="['fas', 'photo-film']" class="font-20-px m-1"
              /></a>
              <a
                *ngIf="userChat.roomId"
                class="nav-icon cursor"
                data-toggle="tooltip"
                data-placement="bottom"
                title="Create Group"
                (click)="createGroup()"
                ><fa-icon [icon]="['fas', 'users']" class="font-20-px m-1"
              /></a>
              <a
                *ngIf="callRoomId !== userChat.roomId"
                class="nav-icon cursor"
                data-toggle="tooltip"
                data-placement="bottom"
                title="{{ isOnCall ? 'Add in Call' : 'Video Call' }}"
                (click)="startCall()"
              >
                <fa-icon
                  *ngIf="!isOnCall"
                  [icon]="['fas', 'phone']"
                  class="font-20-px m-1"
                />
                <fa-icon
                  *ngIf="isOnCall"
                  [icon]="['fas', 'phone-volume']"
                  class="font-20-px m-1"
                />
              </a>
            </div>

            <div ngbDropdown class="avatar-item online-status d-flex d-sm-none">
              <!--  -->
              <ng-container>
                <button ngbDropdownToggle class="d-center smtxt">
                  <fa-icon [icon]="['fas', 'ellipsis-v']" />
                </button>
                <div ngbDropdownMenu class="dropdown-menu">
                  <div class="dropdown-preferences">
                    <div class="d-flex flex-column">
                      <div
                        class="c-pointer d-flex align-items-baseline gap-2"
                        ngbDropdownItem
                      >
                        <a
                          [ngClass]="sidebarClass ? 'd-none' : ''"
                          *ngIf="userChat.roomId || userChat.groupId"
                          class="nav-icon cursor d-flex align-items-center gap-2"
                          data-toggle="tooltip"
                          data-placement="bottom"
                          title="Media Gallery"
                          (click)="openMediaGallery()"
                          ><fa-icon
                            [icon]="['fas', 'photo-film']"
                            class="font-20-px m-1"
                          />
                          <span>Gallery</span>
                        </a>
                      </div>
                      <div
                        class="c-pointer d-flex align-items-baseline gap-2"
                        ngbDropdownItem
                      >
                        <a
                          *ngIf="userChat.roomId"
                          class="nav-icon cursor d-flex align-items-center gap-2"
                          data-toggle="tooltip"
                          data-placement="bottom"
                          title="Create Group"
                          (click)="createGroup()"
                          ><fa-icon
                            [icon]="['fas', 'users']"
                            class="font-20-px m-1"
                          />
                          <span>Create Group</span>
                        </a>
                      </div>
                      <div
                        class="c-pointer d-flex align-items-baseline gap-2"
                        ngbDropdownItem
                      >
                        <a
                          (click)="openSearch(isSearch)"
                          class="nav-icon cursor d-flex align-items-center gap-2"
                          data-toggle="tooltip"
                          data-placement="bottom"
                          title="Search"
                        >
                          <fa-icon
                            [icon]="['fas', 'search']"
                            class="font-20-px m-1 ms-3 d-flex c-pointer"
                          />
                          <span>Search</span>
                        </a>
                        <!-- <a
                          class="nav-icon cursor d-flex align-items-center gap-2"
                          data-toggle="tooltip"
                          data-placement="bottom"
                          title="Video Call"
                          (click)="startCall()"
                          ><fa-icon
                            [icon]="['fas', 'phone']"
                            class="font-20-px m-1"
                          />
                          <span>Start Call</span>
                        </a> -->
                      </div>
                    </div>
                  </div>
                </div>
              </ng-container>
            </div>
          </div>
        </div>

        <ng-container *ngIf="isSearch">
          <div class="searchChatBar">
            <div class="d-flex gap-3">
              <div class="input-area py-2 d-flex align-items-center w-100">
                <input
                  type="text"
                  [(ngModel)]="searchQuery"
                  (change)="onSearch($event)"
                  (keydown.enter)="nextHighlighted()"
                  (keydown.shift.enter)="previousHighlighted()"
                  placeholder="Find a message in current conversation"
                />
                <fa-icon
                  [icon]="['fas', 'xmark']"
                  *ngIf="searchQuery"
                  (click)="clearSearchQuery()"
                />
              </div>
              <div class="d-flex gap-2">
                <button (click)="nextHighlighted()">
                  <fa-icon
                    [icon]="['fas', 'circle-chevron-up']"
                    class="font-24-px me-2"
                  ></fa-icon>
                </button>
                <button (click)="previousHighlighted()">
                  <fa-icon
                    [icon]="['fas', 'circle-chevron-down']"
                    class="font-24-px me-2"
                  ></fa-icon>
                </button>
              </div>
              <button (click)="openSearch(isSearch)">Cancel</button>
            </div>
          </div>
        </ng-container>
      </div>

      <app-chat-ui
        [userChat]="userChat"
        [sidebarClass]="sidebarClass"
        [activePage]="activePage"
      />

      <div
        class="text-end chat-footer position-relative w-100 px-sm-6 bg-color"
        *ngIf="userChat.isAccepted === 'Y'"
      >
        <ng-container *ngIf="viewUrl && !pdfName">
          <div class="position-absolute mt-5 p-3 preview-chat-media">
            <fa-icon
              *ngIf="replyMessage.Username && replyMessage.createdDate"
              class="float-start me-2"
              [icon]="['fas', 'reply']"
            />
            <img
              loading="lazy"
              data-src="{{ viewUrl }}"
              class="w-100-px h-100-px rounded-4"
              alt="icon"
              onerror="this.onerror=null;"
            />
            <fa-icon
              [icon]="['fas', 'xmark']"
              class="position-absolute top-0 start-100 translate-middle badge bg-danger p-1 font-12-px c-pointer c-icon-color"
              role="button"
              (click)="removePostSelectedFile()"
            />
            <ng-container
              *ngIf="replyMessage.Username && replyMessage.createdDate"
            >
              <div class="d-flex">
                <span class="font-12-px mt-2 replay-border"
                  >{{ replyMessage.Username }},
                  {{ replyMessage.createdDate | date : "dd-MM-yyyy" }}</span
                >
              </div>
            </ng-container>
          </div>
        </ng-container>
        <ng-container *ngIf="selectedFile?.type?.includes('video/')">
          <div class="position-absolute mt-5 p-3 preview-chat-media">
            <fa-icon
              *ngIf="replyMessage.Username && replyMessage.createdDate"
              class="float-start me-2"
              [icon]="['fas', 'reply']"
            />
            <video
              class="w-100 h-200-px"
              src="{{ viewUrl }}"
              controls
              autoplay="autoplay"
            ></video>
            <fa-icon
              [icon]="['fas', 'xmark']"
              class="position-absolute top-0 start-100 translate-middle badge bg-danger p-1 font-12-px c-pointer c-icon-color"
              role="button"
              (click)="removePostSelectedFile()"
            />
            <ng-container
              *ngIf="replyMessage.Username && replyMessage.createdDate"
            >
              <div class="d-flex">
                <span class="font-12-px mt-2 replay-border"
                  >{{ replyMessage.Username }},
                  {{ replyMessage.createdDate | date : "dd-MM-yyyy" }}</span
                >
              </div>
            </ng-container>
          </div>
        </ng-container>

        <ng-container *ngIf="pdfName">
          <div class="position-absolute mt-5 p-3 preview-chat-media">
            <fa-icon
              *ngIf="replyMessage.Username && replyMessage.createdDate"
              class="float-start me-2"
              [icon]="['fas', 'reply']"
            />
            <fa-icon
              [icon]="['fas', 'file']"
              class="c-pointer close-icon font-40-px"
            />
            <span
              class="c-pdf-show w-100-px"
              [title]="pdfName.replaceAll('%', ' ')"
              >{{ pdfName.replaceAll("%", " ") }}</span
            >
            <fa-icon
              [icon]="['fas', 'xmark']"
              class="position-absolute top-0 translate-middle badge bg-danger p-1 font-12-px c-pointer c-icon-color"
              role="button"
              (click)="removePostSelectedFile()"
            />
            <ng-container
              *ngIf="replyMessage.Username && replyMessage.createdDate"
            >
              <div class="d-flex">
                <span class="font-12-px replay-border"
                  >{{ replyMessage.Username }},
                  {{ replyMessage.createdDate | date : "dd-MM-yyyy" }}</span
                >
              </div>
            </ng-container>
          </div>
        </ng-container>
        <ng-container
          *ngIf="
            typingData?.isTyping &&
            userChat.roomId === typingData.roomId &&
            userChat.groupId === typingData.groupId &&
            typingData.profileId !== profileId
          "
        >
          <span class="mdtxt d-flex position-absolute bottom-100">{{
            typingData.Username + " is typing..."
          }}</span>
        </ng-container>

        <ng-container *ngIf="replyMessage?.msgText">
          <div class="position-absolute replay-chat mb-0 mb-lg-0">
            <fa-icon class="float-end" [icon]="['fas', 'reply']" />
            <div class="replay-message-box">
              <p
                *ngIf="replyMessage.msgText !== null"
                class="m-0"
                [innerHTML]="replyMessage.msgText"
              ></p>
            </div>
            <fa-icon
              [icon]="['fas', 'xmark']"
              class="position-absolute top-0 translate-middle badge bg-danger p-1 font-12-px c-pointer c-icon-color"
              role="button"
              (click)="removeReplay()"
            />
            <div class="d-flex">
              <span class="font-12-px replay-border"
                >{{ replyMessage.Username }},
                {{ replyMessage.createdDate | date : "dd-MM-yyyy" }}</span
              >
            </div>
          </div>
        </ng-container>

        <form
          class="p-2 message-content"
          [ngClass]="!sidebarClass ? 'p-sm-3' : ''"
        >
          <div
            class="d-flex align-items-sm-center align-items-end flex-column flex-sm-row mt-2 gap-3"
          >
            <div class="form-content p-0 d-flex gap-2 align-items-center w-100">
              <div
                [ngClass]="sidebarClass ? 'd-none' : 'd-sm-flex'"
                class="file-input d-flex d-none gap-1 gap-md-2"
              >
                <div class="file-upload">
                  <label class="file">
                    <input
                      type="file"
                      [(ngModel)]="chatObj.msgMedia"
                      [ngModelOptions]="{ standalone: true }"
                      name="doc"
                      accept="application/*"
                      (change)="onPostFileSelect($event)"
                    />
                    <span class="file-custom border-0 m-1 d-grid text-center">
                      <fa-icon
                        [icon]="['fas', 'paperclip']"
                        class="font-20-px"
                      />
                    </span>
                  </label>
                </div>
                <div class="file-upload">
                  <label class="file">
                    <input
                      type="file"
                      [(ngModel)]="chatObj.msgMedia"
                      [ngModelOptions]="{ standalone: true }"
                      name="image"
                      accept="image/*"
                      (change)="onPostFileSelect($event)"
                    />
                    <span class="file-custom border-0 m-1 d-grid text-center">
                      <fa-icon [icon]="['fas', 'image']" class="font-20-px" />
                    </span>
                  </label>
                </div>
                <div class="file-upload">
                  <label class="file">
                    <input
                      type="file"
                      [(ngModel)]="chatObj.msgMedia"
                      [ngModelOptions]="{ standalone: true }"
                      id="fileInput"
                      (change)="onPostFileSelect($event)"
                      accept="video/*"
                    />
                    <span class="file-custom border-0 m-1 d-grid text-center">
                      <fa-icon [icon]="['fas', 'video']" class="font-20-px" />
                    </span>
                  </label>
                </div>
              </div>
              <div class="group-input-field position-relative w-100">
                <app-tag-user-input
                  class="message-input-field message-text"
                  placeholder="Message.."
                  [value]="messageInputValue"
                  [isShowMetaLoader]="false"
                  [isAllowTagUser]="userChat.roomId ? false : true"
                  [isShowMetaPreview]="false"
                  [isCopyImagePreview]="false"
                  [isShowEmojis]="true"
                  [placement]="'top-start'"
                  [isCustomeSearch]="
                    userChat?.groupId ? userChat?.groupId : null
                  "
                  (onDataChange)="onTagUserInputChangeEvent($event)"
                  (keypress)="startTypingChat(true)"
                  (keydown.enter)="
                    this.chatObj.msgText !== null
                      ? uploadPostFileAndCreatePost()
                      : null
                  "
                  (keydown.shift.enter)="$event.stopPropagation()"
                />
              </div>
              <div class="btn-area">
                <button
                  class="cmn-btn message lh-lg"
                  [ngClass]="sidebarClass ? 'px-2' : 'px-2 px-sm-5 px-lg-6'"
                  (click)="uploadPostFileAndCreatePost()"
                >
                  <fa-icon
                    [ngClass]="sidebarClass ? '' : 'd-sm-none'"
                    class="c-icon-color"
                    [icon]="['fas', 'paper-plane']"
                  ></fa-icon>
                  <div [ngClass]="sidebarClass ? 'd-none' : 'd-none d-sm-flex'">
                    Send
                  </div>
                </button>
              </div>
            </div>
          </div>
          <div
            [ngClass]="sidebarClass ? 'd-block' : 'd-block d-sm-none'"
            class="file-upload mobile-fileselect-drop"
          >
            <!-- <div class="d-flex ms-11 select-emaojies"> -->
            <div class="d-center gap-10 ms-11 pt-2 select-emaojies">
              <label class="file">
                <input
                  type="file"
                  [(ngModel)]="chatObj.msgMedia"
                  [ngModelOptions]="{ standalone: true }"
                  name="doc"
                  accept="application/*"
                  (change)="onPostFileSelect($event)"
                />
                <span class="file-custom border-0 m-1 d-grid text-center">
                  <fa-icon
                    [icon]="['fas', 'paperclip']"
                    class="font-24-px"
                  ></fa-icon>
                </span>
              </label>
              <label class="file">
                <input
                  type="file"
                  [(ngModel)]="chatObj.msgMedia"
                  [ngModelOptions]="{ standalone: true }"
                  name="image"
                  accept="image/*"
                  (change)="onPostFileSelect($event)"
                />
                <span class="file-custom border-0 m-1 d-grid text-center">
                  <fa-icon
                    [icon]="['fas', 'image']"
                    class="font-24-px"
                  ></fa-icon>
                </span>
              </label>
              <label class="file">
                <input
                  type="file"
                  [(ngModel)]="chatObj.msgMedia"
                  [ngModelOptions]="{ standalone: true }"
                  id="fileInput"
                  (change)="onPostFileSelect($event)"
                  accept="video/*"
                />
                <span class="file-custom border-0 m-1 d-grid text-center">
                  <fa-icon
                    [icon]="['fas', 'video']"
                    class="font-24-px"
                  ></fa-icon>
                </span>
              </label>
            </div>
          </div>
        </form>
      </div>
    </div>
  </ng-container>
</div>
