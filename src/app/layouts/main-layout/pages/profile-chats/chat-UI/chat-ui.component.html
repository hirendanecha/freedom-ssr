<div
  [ngClass]="sidebarClass ? 'chat-content-sidepanel' : 'chat-content'"
  class="position-relative"
  #chatContent
  (scroll)="onScroll($event)"
>
  <ng-container
    *ngIf="userChat?.createdBy !== profileId && userChat.isAccepted === 'N'"
  >
    <div class="d-flex flex-column align-items-center mt-5">
      <div
        class="d-flex flex-column justify-content-center align-items-center gap-3 my-8 p-6 rounded-3 box-bg"
      >
        <img
          [src]="userChat.ProfilePicName"
          class="w-60-px h-60-px"
          alt="image"
        />
        <h5>{{ userChat?.Username }} wants to connect with you</h5>
        <div>
          <button class="btn btn-danger mx-3" (click)="onCancel()">
            Cancel
          </button>
          <button class="btn btn-primary mx-3" (click)="acceptRoom()">
            Accept
          </button>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- ui third -->
  <ng-container
    *ngIf="userChat?.createdBy === profileId && userChat.isAccepted === 'N'"
  >
    <div class="d-flex flex-column align-items-center mt-5">
      <div
        class="d-flex flex-column justify-content-center align-items-center gap-3 my-8 p-6 rounded-3 box-bg"
      >
        <img
          [src]="userChat.ProfilePicName"
          class="rounded-circle w-60-px h-60-px"
          alt="image"
          onerror="this.onerror=null;this.src='/assets/images/avtar/placeholder-user.png'"
        />
        <h5>{{ userChat?.Username }} has not yet accepted the invite</h5>
      </div>
    </div>
  </ng-container>

  <ng-container
    *ngIf="
      (userChat?.roomId || userChat?.groupId) && userChat.isAccepted === 'Y'
    "
  >
    <ul class="py-2 px-3 cus-scrollbar bottom-0 main-chat-box">
      <ng-container *ngFor="let msg of filteredMessageList;trackBy: trackByFn">
        <span class="d-flex w-100 justify-content-center custom-border">
          {{ msg?.date || "Today" }}</span
        >
        <ng-container *ngFor="let message of msg?.messages; let i = index;trackBy: messageTrackByFn">
          <div
            class="d-flex"
            *ngIf="
              message?.sentBy !== this.profileId &&
              message?.createdDate &&
              message?.Username
            "
          >
            <span class="font-12-px data-text-color ms-3"
              >{{ message?.Username }},
              {{ displayLocalTime(message?.createdDate) }}</span
            >
          </div>
          <li
            class="you"
            #message
            [class.highlighted]="i === currentHighlightedIndex"
          >
            <div
              class="d-flex drop-options"
              *ngIf="message?.sentBy !== this.profileId"
            >
              <div class="btn-group d-flex options me-2">
                <div
                  *ngIf="message?.messageMedia || message?.messageText"
                  ngbDropdown
                  #editPopup="ngbDropdown"
                  class="d-inline-block"
                >
                  <button class="dropdown-btn" ngbDropdownToggle>
                    <fa-icon
                      [icon]="['fas', 'ellipsis-v']"
                      class="font-20-px"
                    />
                  </button>
                  <div
                    ngbDropdownMenu
                    class="dropdown-menu"
                    (mouseleave)="editPopup.close()"
                  >
                    <button
                      ngbDropdownItem
                      (click)="replyMsg(message)"
                      *ngIf="message?.messageMedia || message?.messageText"
                    >
                      <a class="droplist d-flex align-items-center gap-2">
                        <fa-icon [icon]="['fas', 'reply']" />
                        <span class="data-text-color">Reply</span>
                      </a>
                    </button>
                    <button
                      ngbDropdownItem
                      (click)="forwardMsg(message)"
                      *ngIf="message?.messageMedia || message?.messageText"
                    >
                      <a class="droplist d-flex align-items-center gap-2">
                        <fa-icon
                          class="forward-msg"
                          [icon]="['fas', 'reply']"
                        />
                        <span class="data-text-color">Forward</span>
                      </a>
                    </button>
                    <ng-container
                      *ngIf="message?.messageMedia || message?.metaData?.url"
                    >
                      <button ngbDropdownItem>
                        <a
                          class="droplist d-flex align-items-center gap-2"
                          [appCopyClipboard]="
                            message?.messageMedia || message?.metaData?.url
                          "
                        >
                          <fa-icon [icon]="['fas', 'link']" />
                          <span class="data-text-color">Copy link</span>
                        </a>
                      </button>
                    </ng-container>
                    <ng-container *ngIf="message?.messageMedia">
                      <button
                        ngbDropdownItem
                        (click)="downloadMedia(message?.messageMedia)"
                      >
                        <a class="droplist d-flex align-items-center gap-2">
                          <fa-icon [icon]="['fas', 'download']" />
                          <span class="data-text-color">Download</span>
                        </a>
                      </button>
                    </ng-container>
                  </div>
                </div>
              </div>
              <div class="d-flex flex-column">
                <div class="d-flex">
                  <ng-container *ngIf="message?.messageMedia">
                    <div class="mb-3">
                      <ng-container
                        *ngIf="isPdf(message?.messageMedia); else imageMsg"
                      >
                        <div
                          class="message"
                          (click)="pdfView(message?.messageMedia)"
                        >
                          <fa-icon
                            [icon]="['fas', 'file']"
                            class="c-pointer close-icon font-44-px"
                          ></fa-icon>
                          <p
                            class="pdf-name text-truncate mb-0"
                            [title]="pdfmsg"
                          >
                            {{ pdfmsg }}
                          </p>
                        </div>
                      </ng-container>
                      <ng-template #imageMsg>
                        <ng-container
                          *ngIf="isGif(message?.messageMedia); else notGif"
                          ><div class="message">
                            <img
                              data-src="{{ message?.messageMedia }}"
                              loading="eager"
                              class="emoji-style h-60-px"
                              alt="Emoji"
                              draggable="false"
                            />
                          </div>
                        </ng-container>
                        <ng-template #notGif>
                          <ng-container
                            *ngIf="
                              isVideoFile(message?.messageMedia);
                              else imageMessage
                            "
                          >
                            <video
                              class="w-100 h-200-px replay-message-media"
                              [src]="message?.messageMedia"
                              controls
                            ></video>
                          </ng-container>
                          <ng-template #imageMessage>
                            <div class="replay-message-media">
                              <app-img-preview
                                class="msgImage"
                                classes="h-180-px"
                                [src]="message?.messageMedia"
                              ></app-img-preview>
                            </div>
                          </ng-template>
                        </ng-template>
                      </ng-template>
                    </div>
                  </ng-container>
                </div>
                <div
                  *ngIf="
                    message?.messageText !== null || message?.parentMessageId
                  "
                  class="message d-flex gap-3 flex-column"
                >
                  <ng-container *ngIf="message?.parentMessageId">
                    <div class="parent-replay-alt">
                      <fa-icon [icon]="['fas', 'reply']" />
                      <ng-container
                        *ngIf="message?.parentMessage?.messageMedia"
                      >
                        <ng-container
                          *ngIf="
                            !isFileOrVideo(
                              message?.parentMessage?.messageMedia
                            );
                            else fileReplay
                          "
                        >
                          <div class="w-100-px h-100-px">
                            <app-img-preview
                              classes="h-100-px"
                              [src]="message?.parentMessage?.messageMedia"
                            ></app-img-preview>
                          </div>
                        </ng-container>
                        <ng-template #fileReplay>
                          <div
                            class="w-100-px h-100-px"
                            (click)="
                              downloadMedia(
                                message?.parentMessage?.messageMedia
                              )
                            "
                          >
                            <fa-icon
                              [icon]="['fas', 'file']"
                              class="c-pointer close-icon font-40-px"
                            />
                            <span
                              class="c-pdf-show"
                              [title]="
                                message?.parentMessage?.messageMedia?.replaceAll(
                                  '%',
                                  ' '
                                )
                              "
                              >{{
                                message?.parentMessage?.messageMedia?.replaceAll(
                                  "%",
                                  " "
                                )
                              }}</span
                            >
                          </div>
                        </ng-template>
                      </ng-container>
                      <p
                        *ngIf="message?.parentMessage?.messageText !== null"
                        class="m-0"
                        [innerHTML]="message?.parentMessage?.messageText"
                      ></p>
                      <span class="font-12-px"
                        >{{ message?.parentMessage?.Username }},
                        {{
                          message?.parentMessage?.createdDate
                            | date : "dd-MM-yyyy"
                        }}</span
                      >
                    </div>
                  </ng-container>
                  <div class="d-flex flex-column">
                    <p
                      *ngIf="message.messageText !== null"
                      class="m-0 message-text-custom"
                      [innerHTML]="
                        (message?.messageText | highlight : searchQuery) +
                        ((message?.messageText === 'Declined call' ||
                          message?.messageText === 'Missed call') &&
                        userChat.groupId
                          ? '&nbsp;from&nbsp;' + '@' + message?.Username
                          : '')
                      "
                    ></p>

                    <ng-container *ngIf="message?.metaData">
                      <div class="chat-meta">
                        <app-post-meta-data-card
                          [post]="message.metaData"
                          class="pt-2"
                        />
                      </div>
                    </ng-container>
                  </div>
                </div>
              </div>
            </div>
          </li>

          <li
            class="me d-flex flex-column gap-1"
            #message
            [class.highlighted]="i === currentHighlightedIndex"
          >
            <ng-container *ngIf="message?.sentBy === this.profileId">
              <ng-container *ngIf="userChat?.roomId">
                <div
                  class="d-flex flex-row-reverse pb-2 gap-1"
                  *ngIf="
                    message?.id === unreadMessage?.message?.id &&
                    msg?.date === unreadMessage?.date
                  "
                >
                  <div
                    class="c-pointer"
                    [title]="userChat.Username || userChat.FirstName"
                  >
                    <img
                      loading="lazy"
                      data-src="{{ userChat.ProfilePicName }}"
                      class="rounded-circle h-20-px w-20-px"
                      draggable="false"
                      onerror="this.onerror=null;this.src='/assets/images/avtar/placeholder-user.png';"
                    />
                  </div>
                </div>
              </ng-container>
              <ng-container *ngIf="userChat?.groupId">
                <ng-container *ngFor="let member of relevantMembers">
                  <div
                    class="d-flex flex-row-reverse pb-2 gap-1"
                    *ngIf="message?.id === member?.message?.id"
                  >
                    <div
                      class="c-pointer"
                      [title]="member.Username || member.FirstName"
                    >
                      <img
                        loading="lazy"
                        data-src="{{ member.ProfilePicName }}"
                        class="rounded-circle h-20-px w-20-px"
                        draggable="false"
                        onerror="this.onerror=null;this.src='/assets/images/avtar/placeholder-user.png';"
                      />
                    </div>
                  </div>
                </ng-container>
              </ng-container>
              <span class="font-12-px data-text-color me-3">{{
                displayLocalTime(message?.createdDate)
              }}</span>
              <ng-container *ngIf="message?.messageMedia">
                <div class="d-flex flex-row-reverse gap-2 drop-options">
                  <div class="btn-group d-flex options">
                    <div
                      ngbDropdown
                      #editPopup="ngbDropdown"
                      class="d-inline-block"
                    >
                      <button class="dropdown-btn" ngbDropdownToggle>
                        <fa-icon
                          [icon]="['fas', 'ellipsis-v']"
                          class="font-20-px"
                        />
                      </button>
                      <div
                        ngbDropdownMenu
                        class="dropdown-menu"
                        (mouseleave)="editPopup.close()"
                      >
                        <button
                          ngbDropdownItem
                          (click)="replyMsg(message)"
                          *ngIf="message?.messageMedia || message?.messageText"
                        >
                          <a class="droplist d-flex align-items-center gap-2">
                            <fa-icon [icon]="['fas', 'reply']" />
                            <span class="data-text-color">Reply</span>
                          </a>
                        </button>
                        <button
                          ngbDropdownItem
                          (click)="forwardMsg(message)"
                          *ngIf="message?.messageMedia || message?.messageText"
                        >
                          <a class="droplist d-flex align-items-center gap-2">
                            <fa-icon
                              class="forward-msg"
                              [icon]="['fas', 'reply']"
                            />
                            <span class="data-text-color">Forward</span>
                          </a>
                        </button>
                        <button
                          ngbDropdownItem
                          (click)="editMsg(message)"
                          *ngIf="message?.messageText"
                        >
                          <a class="droplist d-flex align-items-center gap-2">
                            <fa-icon [icon]="['fas', 'pen-to-square']" />
                            <span class="data-text-color">Edit</span>
                          </a>
                        </button>
                        <button
                          ngbDropdownItem
                          (click)="deleteMsg(message, msg?.date)"
                        >
                          <a class="droplist d-flex align-items-center gap-2">
                            <fa-icon [icon]="['fas', 'trash-can']" />
                            <span class="data-text-color">Delete</span>
                          </a>
                        </button>
                        <ng-container
                          *ngIf="
                            message?.messageMedia || message?.metaData?.url
                          "
                        >
                          <button ngbDropdownItem>
                            <a
                              class="droplist d-flex align-items-center gap-2"
                              [appCopyClipboard]="
                                message?.messageMedia || message?.metaData?.url
                              "
                            >
                              <fa-icon [icon]="['fas', 'link']" />
                              <span class="data-text-color">Copy link</span>
                            </a>
                          </button>
                        </ng-container>
                      </div>
                    </div>
                  </div>
                  <div>
                    <ng-container
                      *ngIf="isPdf(message?.messageMedia); else imageMsg"
                    >
                      <div
                        class="message"
                        (click)="pdfView(message?.messageMedia)"
                      >
                        <fa-icon
                          [icon]="['fas', 'file']"
                          class="c-pointer close-icon font-44-px"
                        ></fa-icon>
                        <p class="pdf-name text-truncate mb-0" [title]="pdfmsg">
                          {{ pdfmsg }}
                        </p>
                      </div>
                    </ng-container>
                    <ng-template #imageMsg>
                      <ng-container
                        *ngIf="isGif(message?.messageMedia); else notGif"
                      >
                        <div class="message">
                          <img
                            data-src="{{ message?.messageMedia }}"
                            loading="eager"
                            class="emoji-style h-60-px"
                            alt="Emoji"
                            draggable="false"
                          />
                        </div>
                      </ng-container>
                      <ng-template #notGif>
                        <ng-container
                          *ngIf="
                            isVideoFile(message?.messageMedia);
                            else imageMessage
                          "
                        >
                          <video
                            class="w-100 h-200-px message-media"
                            [src]="message?.messageMedia"
                            controls
                          ></video>
                        </ng-container>
                        <ng-template #imageMessage>
                          <div class="message-media">
                            <app-img-preview
                              class="msgImage"
                              classes="h-180-px"
                              [src]="message?.messageMedia"
                            ></app-img-preview>
                          </div>
                        </ng-template>
                      </ng-template>
                    </ng-template>
                  </div>
                </div>
              </ng-container>
              <div
                *ngIf="
                  message?.messageText !== null || message?.parentMessageId
                "
                class="d-flex flex-row-reverse gap-2 drop-options"
              >
                <div class="btn-group d-flex options">
                  <div
                    ngbDropdown
                    #editPopup="ngbDropdown"
                    class="d-inline-block"
                  >
                    <button class="dropdown-btn" ngbDropdownToggle>
                      <fa-icon
                        [icon]="['fas', 'ellipsis-v']"
                        class="font-20-px"
                      />
                    </button>
                    <div
                      ngbDropdownMenu
                      class="dropdown-menu"
                      (mouseleave)="editPopup.close()"
                    >
                      <button
                        ngbDropdownItem
                        (click)="replyMsg(message)"
                        *ngIf="message?.messageMedia || message?.messageText"
                      >
                        <a class="droplist d-flex align-items-center gap-2">
                          <fa-icon [icon]="['fas', 'reply']" />
                          <span class="data-text-color">Reply</span>
                        </a>
                      </button>
                      <button
                        ngbDropdownItem
                        (click)="forwardMsg(message)"
                        *ngIf="message?.messageMedia || message?.messageText"
                      >
                        <a class="droplist d-flex align-items-center gap-2">
                          <fa-icon
                            class="forward-msg"
                            [icon]="['fas', 'reply']"
                          />
                          <span class="data-text-color">Forward</span>
                        </a>
                      </button>
                      <button
                        ngbDropdownItem
                        (click)="editMsg(message)"
                        *ngIf="message?.messageText"
                      >
                        <a class="droplist d-flex align-items-center gap-2">
                          <fa-icon [icon]="['fas', 'pen-to-square']" />
                          <span class="data-text-color">Edit</span>
                        </a>
                      </button>
                      <button
                        ngbDropdownItem
                        (click)="deleteMsg(message, msg.date)"
                      >
                        <a class="droplist d-flex align-items-center gap-2">
                          <fa-icon [icon]="['fas', 'trash-can']" />
                          <span class="data-text-color">Delete</span>
                        </a>
                      </button>
                    </div>
                  </div>
                </div>

                <div class="message d-flex gap-3 flex-column">
                  <ng-container *ngIf="message?.parentMessageId">
                    <div class="parent-replay">
                      <fa-icon [icon]="['fas', 'reply']" />
                      <ng-container *ngIf="message.parentMessage.messageMedia">
                        <ng-container
                          *ngIf="
                            !isFileOrVideo(message.parentMessage.messageMedia);
                            else fileReplay
                          "
                        >
                          <div class="w-100-px h-100-px">
                            <app-img-preview
                              class="msgImage"
                              classes="h-100-px"
                              [src]="message.parentMessage.messageMedia"
                            ></app-img-preview>
                          </div>
                        </ng-container>
                        <ng-template #fileReplay>
                          <div
                            class="w-100-px h-100-px"
                            (click)="
                              downloadMedia(
                                message?.parentMessage?.messageMedia
                              )
                            "
                          >
                            <fa-icon
                              [icon]="['fas', 'file']"
                              class="c-pointer close-icon font-40-px"
                            />
                            <span
                              class="c-pdf-show"
                              [title]="
                                message.parentMessage.messageMedia.replaceAll(
                                  '%',
                                  ' '
                                )
                              "
                              >{{
                                message.parentMessage.messageMedia.replaceAll(
                                  "%",
                                  " "
                                )
                              }}</span
                            >
                          </div>
                        </ng-template>
                      </ng-container>
                      <p
                        *ngIf="message.parentMessage.messageText !== null"
                        class="m-0"
                        [innerHTML]="message.parentMessage.messageText"
                      ></p>
                      <span class="font-12-px"
                        >{{ message.parentMessage.Username }},
                        {{
                          message?.parentMessage.createdDate
                            | date : "dd-MM-yyyy"
                        }}</span
                      >
                    </div>
                  </ng-container>
                  <div class="d-flex flex-column">
                    <p
                      *ngIf="message?.messageText !== null"
                      class="m-0 message-text-custom"
                      [innerHTML]="
                        message?.messageText === 'Missed call'
                          ? 'No answer'
                          : (message.messageText | highlight : searchQuery)
                      "
                    ></p>
                    <ng-container *ngIf="message?.metaData">
                      <div class="chat-meta">
                        <app-post-meta-data-card
                          [post]="message.metaData"
                          class="pt-2"
                        />
                      </div>
                    </ng-container>
                  </div>
                </div>
              </div>
            </ng-container>
          </li>
        </ng-container>
      </ng-container>
    </ul>

    <app-inline-loader *ngIf="isFileUploadInProgress && !progressValue" />
    <ng-container *ngIf="progressValue">
      <!-- <div class="container d-flex justify-content-center padding"> -->
      <div class="padding position-fixed top-50 start-50 end-50">
        <div class="row ps-lg-20">
          <div class="col-12">
            <div class="progress">
              <span>
                <span
                  class="progress-bar"
                  [ngStyle]="{
                    transform: 'rotate(' + updateProgress() + 'deg)'
                  }"
                ></span>
              </span>
              <div class="progress-value">{{ progressValue }}</div>
            </div>
          </div>
        </div>
      </div>
    </ng-container>
    <ng-container *ngIf="filteredMessageList?.length">
      <ng-container
        *ngIf="
          userChat?.groupId || (userChat?.roomId && readMessageRoom === 'Y')
        "
      >
        <div class="d-flex flex-row-reverse pb-2 pe-6 gap-1" ngbDropdown>
          <ng-container
            *ngFor="let item of userChat?.groupId ? readMessagesBy : [userChat]"
          >
            <div
              class="c-pointer"
              [title]="item.Username || item.FirstName"
              ngbDropdownToggle
            >
              <img
                loading="lazy"
                data-src="{{ item.ProfilePicName }}"
                class="rounded-circle h-20-px w-20-px"
                draggable="false"
                onerror="this.onerror=null;this.src='/assets/images/avtar/placeholder-user.png';"
              />
            </div>
          </ng-container>
          <div ngbDropdownMenu class="w-228-px">
            <div class="h6 ms-3 btn-link">
              READ BY {{ userChat?.groupId ? readMessagesBy.length : "" }}
            </div>
            <ng-container
              *ngFor="
                let item of userChat.groupId ? readMessagesBy : [userChat]
              "
            >
              <button ngbDropdownItem>
                <div class="d-flex align-items-center gap-2">
                  <img
                    loading="lazy"
                    data-src="{{ item.ProfilePicName }}"
                    class="rounded-circle h-28-px w-28-px"
                    draggable="false"
                    onerror="this.onerror=null;this.src='/assets/images/avtar/placeholder-user.png';"
                  />
                  <div class="replay-text">
                    {{ item.Username || item.FirstName }}
                  </div>
                </div>
              </button>
            </ng-container>
          </div>
        </div>
      </ng-container>
    </ng-container>
  </ng-container>
</div>
<ng-container *ngIf="showButton">
  <button
    class="scrollToBottom d-flex justify-content-center align-items-center"
    (click)="goToFirstPage()"
    [ngClass]="sidebarClass ? 'active' : ''"
  >
    <fa-icon class="c-icon-color" [icon]="['fas', 'angles-up']"></fa-icon>
  </button>
</ng-container>
